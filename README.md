# Example of Kotlin Spring Boot GraphQL Server with Spring Security authentication and authorization along with Kotlin GraphQL DSL Client generated by means of [Kobby Gradle Plugin](https://github.com/ermadmi78/kobby) from GraphQL Schema

1. See GraphQL schema [here](https://github.com/ermadmi78/kobby-gradle-example/blob/main/cinema-api/src/main/resources/io/github/ermadmi78/kobby/cinema/api/cinema.graphqls)
1. Start server: `./gradlew :cinema-server:bootRun`
1. Try to execute GraphQL queries in [console](http://localhost:8080/graphiql) (for example `query { countries { id name } }`)
1. Start client: `./gradlew :cinema-kotlin-client:bootRun`
1. See queries, generated by Kobby DSL in client output
1. See client source code [here](https://github.com/ermadmi78/kobby-gradle-example/blob/main/cinema-kotlin-client/src/main/kotlin/io/github/ermadmi78/kobby/cinema/kotlin/client/application.kt)
1. Just try to write your own query by means of Kobby DSL!

# Basic HTTP Spring Security support

See example of GraphQL resolvers authorization [here](https://github.com/ermadmi78/kobby-gradle-example/blob/main/cinema-server/src/main/kotlin/io/github/ermadmi78/kobby/cinema/server/resolvers/QueryResolver.kt)

**Coroutine based resolver authorization example:**
```kotlin
suspend fun country(id: Long): CountryDto? = hasAnyRole("USER", "ADMIN") {
    println("Query country by user [${authentication.name}] in thread [${Thread.currentThread().name}]")
    dslContext.selectFrom(COUNTRY)
        .where(COUNTRY.ID.eq(id))
        .fetchAny { it.toDto() }
}
```

**Mono based resolver authorization example:**
```kotlin
@PreAuthorize("hasRole('USER') or hasRole('ADMIN')")
fun film(id: Long): Mono<FilmDto?> = mono(resolverDispatcher) {
    val authentication = getAuthentication()!!
    println("Query film by user [${authentication.name}] in thread [${Thread.currentThread().name}]")

    dslContext.selectFrom(FILM)
        .where(FILM.ID.eq(id))
        .fetchAny { it.toDto() }
}
```

**Flux based resolver authorization example:**
```kotlin
@PreAuthorize("hasRole('USER') or hasRole('ADMIN')")
fun countries(
    name: String?,
    limit: Int,
    offset: Int
): Flux<CountryDto> = flux(resolverDispatcher) {
    val authentication = getAuthentication()!!
    println("Query countries by user [${authentication.name}] in thread [${Thread.currentThread().name}]")

    var condition: Condition = trueCondition()

    if (!name.isNullOrBlank()) {
        condition = condition.and(COUNTRY.NAME.containsIgnoreCase(name.trim()))
    }

    dslContext.selectFrom(COUNTRY)
        .where(condition)
        .limit(offset.prepare(), limit.prepare())
        .fetch { it.toDto() }
        .forEach {
            send(it)
        }
}
```

# Kotlin GraphQL Client DSL support

GraphQL Client DSL in this example is generated by means of [Kobby Gradle Plugin](https://github.com/ermadmi78/kobby) from [GraphQL Schema](https://github.com/ermadmi78/kobby-gradle-example/blob/main/cinema-api/src/main/resources/io/github/ermadmi78/kobby/cinema/api/cinema.graphqls).
See source code [here](https://github.com/ermadmi78/kobby-gradle-example/blob/main/cinema-kotlin-client/src/main/kotlin/io/github/ermadmi78/kobby/cinema/kotlin/client/application.kt). 

## Simple GraphQL query example

**GraphQL query:**
```graphql
{
  country(id: 1) {
    id
    name
  }
}
```

**Kotlin DSL query:**
```kotlin
context.query {
    country(1) {
        // id is required (see @required directive in schema)
        // name is default (see @default directive in schema)
    }
}
```

## Complex GraphQL query example

**GraphQL query:**
```graphql
{
  country(id: 7) {
    id
    name
    films(title: "d") {
      id
      title
      genre
      countryId
      actors(limit: -1) {
        id
        firstName
        lastName
        birthday
        gender
        countryId
        country {
          id
          name
        }
      }
    }
    actors(firstName: "d") {
      id
      fields(keys: ["birthday", "gender"])
      firstName
      lastName
      birthday
      gender
      countryId
      films(limit: -1) {
        id
        title
        countryId
      }
    }
  }
}
```

**Kotlin DSL query:**
```kotlin
context.query {
    country(7) {
        // id is required
        // name is default
        films {
            title = "d" // title is selection argument (see @selection directive in schema)

            // id is required
            // title is default
            genre()
            // countryId is required
            actors {
                limit = -1 // limit is selection argument (see @selection directive in schema)

                // id is required
                // firstName is default
                // lastName is default
                // birthday is required (see @required directive in schema)
                gender()
                // countryId is required
                country {
                    // id is required
                    // name is default
                }
            }
        }
        actors {
            firstName = "d" // firstName is selection argument (see @selection directive in schema)

            // id is required
            fields {
                keys = listOf(
                    "birthday",
                    "gender"
                ) // keys is selection argument (see @selection directive in schema)
            }
            // firstName is default
            // lastName is default
            // birthday is required
            gender()
            // countryId is required
            films {
                limit = -1 // limit is selection argument (see @selection directive in schema)

                // id is required
                // title is default
                // countryId is required
            }
        }
    }
}
```

## GraphQL unions query example

**GraphQL query:**
```graphql
{
  country(id: 17) {
    id
    native {
      __typename
      ... on Film {
        id
        title
        genre
        countryId
      }
      ... on Actor {
        id
        firstName
        lastName
        birthday
        gender
        countryId
        country {
          id
          name
        }
      }
    }
  }
}
```

**Kotlin DSL query:**
```kotlin
context.query {
    country(17) {
        __minimize() // switch off defaults to minimize query
        // id is required
        native {
            // __typename generated by Kobby
            __onFilm {
                // id is required
                // title is default
                genre()
                // countryId is required
            }
            __onActor {
                // id is required
                // firstName is default
                // lastName is default
                // birthday is required
                gender()
                // countryId is required
                country {
                    // id is required
                    // name is default
                }
            }
        }
    }
}
```

## Sugar API

You can supplement the generated GraphQL DSL by your own "sugar" API. 
Source code see [here](https://github.com/ermadmi78/kobby-gradle-example/blob/main/cinema-api/src/main/kotlin/io/github/ermadmi78/kobby/cinema/api/kobby/kotlin/_CinemaContext.kt) and [here](https://github.com/ermadmi78/kobby-gradle-example/blob/main/cinema-api/src/main/kotlin/io/github/ermadmi78/kobby/cinema/api/kobby/kotlin/entity/_Country.kt).

**Let try to use our Kotlin "sugar" API:**
```kotlin
 // Fetch country by id
 val country = context.fetchCountry(7)
 println("Country: id=${country.id} name='${country.name}'")

 //Find all country films
 val films = country.findFilms {
     limit = -1
     genre()
 }

 films.forEach {
     println("Film: id=${it.id}, title='${it.title}' genre=${it.genre}")
 }
```

**This Kotlin DSL code will produce two GraphQL queries:**
```graphql
{
  country(id: 7) {
    id
    name
  }
}
```
```graphql
{
  country(id: 7) {
    id
    films(limit: -1) {
      id
      title
      genre
      countryId
    }
  }
}
```